<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSICOCLAN - Versión Web Multi-Usuario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=Lato:wght@400;700&display=swap');

        :root {
            --bg-color: #fdfbf7;
            --text-color: #2d3748;
            --accent-color: #d97706;
            --sidebar-bg: #1a202c;
            --sidebar-text: #e2e8f0;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Merriweather', serif;
            overflow-x: hidden;
            transition: font-size 0.3s ease;
        }

        /* Marca de Agua Fija */
        .watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 4vw;
            font-weight: bold;
            color: rgba(0, 0, 0, 0.03);
            pointer-events: none;
            z-index: 0;
            white-space: nowrap;
            user-select: none;
            text-align: center;
            font-family: 'Lato', sans-serif;
        }

        /* Estilos de la barra lateral */
        .sidebar {
            font-family: 'Lato', sans-serif;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            transition: transform 0.3s ease-in-out;
        }

        /* Estilo del contenido del libro */
        .book-content {
            line-height: 1.8;
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
        }

        .book-content p {
            margin-bottom: 1.5em;
            text-align: justify;
        }

        .book-content h1, .book-content h2 {
            font-family: 'Lato', sans-serif;
            color: #1a202c;
            margin-top: 2em;
            margin-bottom: 1em;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }

        .fade-in { animation: fadeIn 0.8s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #reading-progress {
            width: 0%;
            height: 4px;
            background: var(--accent-color);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 60;
            transition: width 0.1s;
        }

        /* Estilos para el Modal de Usuarios */
        .user-card {
            transition: all 0.2s;
            cursor: pointer;
        }
        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Marca de Agua -->
    <div class="watermark">
        PSICOCLAN<br>
        <span style="font-size: 0.5em;">Subido por AXELIZ - VERSIÓN WEB ALBERTO</span>
    </div>

    <!-- Barra de Progreso Superior -->
    <div id="reading-progress"></div>

    <!-- Barra Lateral (Navegación) -->
    <nav id="sidebar" class="sidebar w-64 h-full flex flex-col fixed md:relative transform -translate-x-full md:translate-x-0 z-50 shadow-2xl">
        <div class="p-6 border-b border-gray-700 bg-gray-900">
            <h2 class="text-xl font-bold text-white tracking-wider">ÍNDICE</h2>
            <!-- Info del Usuario Actual en Sidebar -->
            <div id="sidebar-user-info" class="mt-2 flex items-center text-amber-500 text-xs font-bold hidden">
                <i class="fas fa-user-circle mr-2"></i>
                <span id="current-user-display-sidebar">Invitado</span>
            </div>
        </div>
        
        <div class="flex-1 overflow-y-auto p-4 space-y-2" id="chapter-list">
            <!-- Los capítulos se generarán aquí con JS -->
        </div>

        <!-- Botón de Cerrar Sesión / Cambiar Usuario -->
        <div class="p-4 border-t border-gray-700">
            <button onclick="logout()" class="w-full bg-gray-700 hover:bg-red-600 text-white py-2 rounded text-xs transition flex items-center justify-center">
                <i class="fas fa-sign-out-alt mr-2"></i> Cambiar Usuario
            </button>
        </div>

        <div class="p-2 bg-gray-800 text-[10px] text-center text-gray-500">
            v1.1 - Multi-User Local
        </div>
    </nav>

    <!-- Contenedor Principal -->
    <main class="flex-1 flex flex-col h-full relative overflow-hidden bg-transparent">
        
        <header class="bg-white/90 backdrop-blur-sm shadow-sm p-4 flex justify-between items-center sticky top-0 z-40">
            <button id="menu-toggle" class="md:hidden text-gray-700 focus:outline-none">
                <i class="fas fa-bars fa-lg"></i>
            </button>
            
            <div class="flex items-center space-x-4 md:ml-0 ml-4">
                <span class="text-sm font-bold text-gray-600 hidden sm:inline">HERRAMIENTAS:</span>
                
                <div class="flex items-center bg-gray-100 rounded-lg p-1">
                    <button onclick="changeFontSize(-1)" class="w-8 h-8 rounded hover:bg-white flex items-center justify-center text-gray-600 transition" title="Reducir letra">
                        <i class="fas fa-minus text-xs"></i>
                    </button>
                    <span class="px-2 text-gray-500"><i class="fas fa-search"></i></span>
                    <button onclick="changeFontSize(1)" class="w-8 h-8 rounded hover:bg-white flex items-center justify-center text-gray-600 transition" title="Aumentar letra">
                        <i class="fas fa-plus text-xs"></i>
                    </button>
                </div>
            </div>

            <div class="flex items-center space-x-4">
                <div class="hidden sm:flex items-center text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                    <i class="fas fa-pen-nib mr-2"></i>
                    <span id="word-count">0</span>&nbsp;palabras
                </div>

                <button onclick="saveBookmark()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md transition flex items-center">
                    <i class="fas fa-bookmark mr-2"></i> <span class="hidden sm:inline">Guardar Avance</span>
                </button>
            </div>
        </header>

        <div id="reader-container" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth">
            <div id="content-display" class="book-content fade-in pb-20">
                <!-- CONTENIDO -->
            </div>
            
            <div class="text-center text-gray-400 text-sm mt-12 mb-8 border-t border-gray-200 pt-8">
                PSICOCLAN &copy; 2025
            </div>
        </div>

    </main>

    <!-- ================= MODALES ================= -->

    <!-- Modal de Selección de Usuario (NUEVO) -->
    <div id="user-modal" class="fixed inset-0 bg-gray-900 z-[100] flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 relative">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800 font-serif mb-2">PSICOCLAN</h1>
                <p class="text-gray-500 text-sm">¿Quién está leyendo hoy?</p>
            </div>

            <!-- Lista de Usuarios Existentes -->
            <div id="user-list-container" class="space-y-3 mb-6 max-h-48 overflow-y-auto">
                <!-- Se llena con JS -->
                <p class="text-center text-gray-400 text-sm italic py-4">No hay perfiles guardados en este dispositivo.</p>
            </div>

            <!-- Crear Nuevo Usuario -->
            <div class="border-t border-gray-200 pt-4">
                <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Nuevo Lector</label>
                <div class="flex space-x-2">
                    <input type="text" id="new-username" placeholder="Tu nombre..." class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-amber-500" onkeypress="handleEnter(event)">
                    <button onclick="createUser()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg font-bold transition">
                        Crear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de "Continuar Lectura" (Separador) -->
    <div id="resume-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-amber-500"></div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Hola, <span id="modal-username" class="text-amber-600">Lector</span></h2>
            <p class="text-gray-600 mb-6">Encontramos tu separador guardado.</p>
            
            <div class="bg-amber-50 p-4 rounded-lg border border-amber-100 mb-6">
                <p class="text-sm text-amber-800 font-semibold">Te quedaste en:</p>
                <p id="saved-chapter-name" class="text-lg text-gray-800 font-serif italic mt-1">...</p>
                <p class="text-xs text-gray-500 mt-2" id="saved-date">...</p>
            </div>

            <div class="flex space-x-3">
                <button onclick="resumeReading()" class="flex-1 bg-amber-600 hover:bg-amber-700 text-white py-3 rounded-lg font-bold transition shadow-lg">
                    Continuar aquí
                </button>
                <button onclick="closeResumeModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 rounded-lg font-bold transition">
                    Ir al inicio
                </button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition duration-300 z-50">
        Acción realizada
    </div>

    <script>
        // --- BASE DE DATOS DEL LIBRO ---
        const bookData = [
            {
                id: "intro",
                title: "Introducción",
                content: `
                    <h1>Bienvenido a PSICOCLAN</h1>
                    <p class="first-letter:text-5xl first-letter:font-bold first-letter:float-left first-letter:mr-2 first-letter:text-amber-600">E</p>
                    <p>ste es el inicio de una experiencia de lectura inmersiva. El sistema está listo para recibir el contenido de 80,000 palabras.</p>
                    <p>Utiliza las herramientas en la parte superior para ajustar el tamaño de la letra a tu gusto. Si necesitas detener tu lectura, presiona el botón "Guardar Avance" y la próxima vez que entres, podrás continuar exactamente donde te quedaste.</p>
                    <p>Por favor, proporciona el primer fragmento de texto para reemplazar esta demostración.</p>
                `
            },
            {
                id: "cap1",
                title: "Capítulo 1: El Comienzo",
                content: `
                    <h2>El despertar</h2>
                    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
                    <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                    <p>Este texto es solo un marcador de posición. Pronto será reemplazado por la narrativa real de PSICOCLAN.</p>
                `
            }
        ];

        // --- ESTADO DE LA APLICACIÓN ---
        let currentFontSize = 18;
        let currentChapterIndex = 0;
        let currentUser = null; // Nombre del usuario actual
        let users = []; // Lista de usuarios guardados

        // --- REFERENCIAS DOM ---
        const contentDisplay = document.getElementById('content-display');
        const chapterList = document.getElementById('chapter-list');
        const readerContainer = document.getElementById('reader-container');
        const wordCountDisplay = document.getElementById('word-count');
        const resumeModal = document.getElementById('resume-modal');
        const userModal = document.getElementById('user-modal');
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const progressBar = document.getElementById('reading-progress');

        // --- INICIALIZACIÓN ---
        function init() {
            loadUsers(); // Cargar lista de usuarios desde localStorage
            
            // Si no hay usuario seleccionado, mostrar modal de selección
            // Se asume que al refrescar se "cierra sesión" por seguridad/privacidad básica, 
            // o podríamos guardar el "lastUser" si prefieres persistencia de sesión.
            // Por ahora, forzamos selección para soportar multi-usuario limpio.
            renderUserSelection();
        }

        // --- GESTIÓN DE USUARIOS ---

        function loadUsers() {
            const storedUsers = localStorage.getItem('psicoclan_users');
            if (storedUsers) {
                users = JSON.parse(storedUsers);
            }
        }

        function renderUserSelection() {
            const container = document.getElementById('user-list-container');
            container.innerHTML = '';

            if (users.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 text-sm italic py-4">No hay perfiles creados.</p>';
                return;
            }

            users.forEach(user => {
                const div = document.createElement('div');
                div.className = 'user-card flex justify-between items-center bg-gray-50 hover:bg-amber-50 p-3 rounded-lg border border-gray-200';
                div.onclick = (e) => {
                    // Evitar que el click en borrar dispare el login
                    if(e.target.closest('.delete-btn')) return;
                    loginUser(user);
                };
                
                div.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full bg-amber-200 text-amber-800 flex items-center justify-center font-bold mr-3">
                            ${user.charAt(0).toUpperCase()}
                        </div>
                        <span class="font-bold text-gray-700">${user}</span>
                    </div>
                    <button class="delete-btn text-gray-400 hover:text-red-500 p-2" onclick="deleteUser('${user}')" title="Borrar perfil">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                container.appendChild(div);
            });
        }

        function createUser() {
            const input = document.getElementById('new-username');
            const name = input.value.trim();

            if (!name) return showToast("Por favor escribe un nombre");
            if (users.includes(name)) return showToast("Ese usuario ya existe");

            users.push(name);
            localStorage.setItem('psicoclan_users', JSON.stringify(users));
            input.value = '';
            
            // Auto-login al crear
            loginUser(name);
        }

        function deleteUser(name) {
            if (!confirm(`¿Estás seguro de borrar el perfil de ${name}? Se perderá su avance.`)) return;

            users = users.filter(u => u !== name);
            localStorage.setItem('psicoclan_users', JSON.stringify(users));
            
            // Borrar también su bookmark
            localStorage.removeItem(`psicoclan_bookmark_${name}`);
            
            renderUserSelection();
        }

        function loginUser(name) {
            currentUser = name;
            
            // UI Update
            document.getElementById('current-user-display-sidebar').innerText = currentUser;
            document.getElementById('sidebar-user-info').classList.remove('hidden');
            
            // Ocultar modal de usuario
            userModal.classList.add('hidden');
            
            // Cargar libro base
            renderSidebar();
            loadContent(0);
            
            // Verificar bookmark específico de este usuario
            checkBookmark();
        }

        function logout() {
            currentUser = null;
            document.getElementById('sidebar-user-info').classList.add('hidden');
            userModal.classList.remove('hidden');
            renderUserSelection();
            
            // Cerrar cualquier modal abierto
            resumeModal.classList.add('hidden');
        }

        function handleEnter(e) {
            if (e.key === 'Enter') createUser();
        }

        // --- FUNCIONALIDAD DEL LIBRO ---

        function renderSidebar() {
            chapterList.innerHTML = '';
            bookData.forEach((chapter, index) => {
                const btn = document.createElement('button');
                btn.className = `w-full text-left px-4 py-3 rounded-lg text-sm transition hover:bg-gray-700 ${index === currentChapterIndex ? 'bg-amber-600 text-white font-bold' : 'text-gray-300'}`;
                btn.innerText = chapter.title;
                btn.onclick = () => {
                    loadContent(index);
                    if (window.innerWidth < 768) toggleSidebar();
                };
                chapterList.appendChild(btn);
            });
        }

        function loadContent(index) {
            currentChapterIndex = index;
            const chapter = bookData[index];
            
            contentDisplay.style.opacity = '0';
            setTimeout(() => {
                contentDisplay.innerHTML = chapter.content;
                contentDisplay.style.opacity = '1';
                readerContainer.scrollTop = 0;
                updateWordCount();
                renderSidebar();
            }, 200);
        }

        function changeFontSize(delta) {
            currentFontSize += delta;
            if (currentFontSize < 14) currentFontSize = 14;
            if (currentFontSize > 32) currentFontSize = 32;
            contentDisplay.style.fontSize = `${currentFontSize}px`;
        }

        function updateWordCount() {
            const text = contentDisplay.innerText || contentDisplay.textContent;
            const count = text.trim().split(/\s+/).length;
            wordCountDisplay.innerText = count;
        }

        readerContainer.addEventListener('scroll', () => {
            const scrollTop = readerContainer.scrollTop;
            const scrollHeight = readerContainer.scrollHeight - readerContainer.clientHeight;
            const progress = (scrollTop / scrollHeight) * 100;
            progressBar.style.width = `${progress}%`;
        });

        // --- SISTEMA DE SEPARADOR MULTI-USUARIO ---

        function saveBookmark() {
            if (!currentUser) return showToast("Error: No hay usuario activo");

            const bookmark = {
                chapterIndex: currentChapterIndex,
                scrollPosition: readerContainer.scrollTop,
                date: new Date().toLocaleString(),
                chapterTitle: bookData[currentChapterIndex].title
            };
            
            // Guardar con clave única del usuario
            localStorage.setItem(`psicoclan_bookmark_${currentUser}`, JSON.stringify(bookmark));
            showToast(`Avance guardado para ${currentUser}`);
        }

        function checkBookmark() {
            if (!currentUser) return;

            // Buscar clave única del usuario
            const saved = localStorage.getItem(`psicoclan_bookmark_${currentUser}`);
            if (saved) {
                const data = JSON.parse(saved);
                document.getElementById('saved-chapter-name').innerText = data.chapterTitle;
                document.getElementById('saved-date').innerText = data.date;
                document.getElementById('modal-username').innerText = currentUser;
                resumeModal.classList.remove('hidden');
            }
        }

        function resumeReading() {
            const saved = localStorage.getItem(`psicoclan_bookmark_${currentUser}`);
            if (saved) {
                const data = JSON.parse(saved);
                loadContent(data.chapterIndex);
                setTimeout(() => {
                    readerContainer.scrollTop = data.scrollPosition;
                }, 300);
                closeResumeModal();
            }
        }

        function closeResumeModal() {
            resumeModal.classList.add('hidden');
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.innerText = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        function toggleSidebar() {
            sidebar.classList.toggle('-translate-x-full');
        }
        menuToggle.addEventListener('click', toggleSidebar);

        window.onload = init;

    </script>
</body>
</html>
